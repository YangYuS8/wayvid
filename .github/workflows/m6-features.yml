name: M6 Features Test

on:
  push:
    branches: [ 'm6-*' ]
  pull_request:
    branches: [ main ]
    paths:
      - 'src/we/**'
      - 'src/backend/niri.rs'
      - 'src/bin/wayvid-gui.rs'
      - 'packaging/aur/**'
      - 'Cargo.toml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Test Steam Workshop integration
  workshop:
    name: Workshop Integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Test Workshop module
        run: |
          cargo test --package wayvid --lib we::workshop
          cargo test --package wayvid --lib we::steam
          cargo test --package wayvid --lib we::parser
  
  # Test Niri backend
  niri:
    name: Niri Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwayland-dev \
            libmpv-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Check Niri backend builds
        run: cargo check --features backend-wayland
      
      - name: Run Niri tests
        run: cargo test --package wayvid --lib backend::niri
  
  # Test GUI builds and compiles
  gui:
    name: GUI Application
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwayland-dev \
            libmpv-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libxkbcommon-dev \
            libfontconfig1-dev
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Build GUI (debug)
        run: cargo build --features gui --bin wayvid-gui
      
      - name: Build GUI (release)
        run: cargo build --release --features gui --bin wayvid-gui
      
      - name: Check GUI size
        run: |
          DEBUG_SIZE=$(du -h target/debug/wayvid-gui | cut -f1)
          RELEASE_SIZE=$(du -h target/release/wayvid-gui | cut -f1)
          echo "Debug build: $DEBUG_SIZE"
          echo "Release build: $RELEASE_SIZE"
  
  # Test AUR package builds
  aur:
    name: AUR Package Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate PKGBUILD syntax
        run: |
          cd packaging/aur
          bash -n PKGBUILD
          bash -n PKGBUILD.stable
      
      - name: Check PKGBUILD variables
        run: |
          cd packaging/aur
          source PKGBUILD
          echo "Package: $pkgname"
          echo "Version: $pkgver"
          echo "Dependencies: ${depends[@]}"
          echo "Optional deps: ${optdepends[@]}"
          
          # Verify GUI is in optdepends
          if echo "${optdepends[@]}" | grep -q "gui"; then
            echo "✅ GUI mentioned in optdepends"
          else
            echo "⚠️ GUI should be in optdepends"
          fi
  
  # Integration test: all M6 features together
  integration:
    name: Full M6 Integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install all dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwayland-dev \
            libmpv-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libxkbcommon-dev \
            libfontconfig1-dev
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true
      
      - name: Build all M6 components
        run: cargo build --all-features --all-targets
      
      - name: Test all M6 components
        run: cargo test --all-features
      
      - name: Verify all binaries exist
        run: |
          ls -lh target/debug/wayvid
          ls -lh target/debug/wayvid-ctl
          ls -lh target/debug/wayvid-gui
          echo "✅ All M6 binaries built successfully"
      
      - name: Upload M6 binaries
        uses: actions/upload-artifact@v4
        with:
          name: m6-integration-binaries
          path: |
            target/debug/wayvid
            target/debug/wayvid-ctl
            target/debug/wayvid-gui
          retention-days: 7
