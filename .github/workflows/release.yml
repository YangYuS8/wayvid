name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'              # æ­£å¼ç‰ˆ: v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+' # Alpha: v1.2.3-alpha.1
      - 'v[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+'  # Beta: v1.2.3-beta.2
      - 'v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+'    # RC: v1.2.3-rc.1
      - 'v[0-9]+.[0-9]+.[0-9]+-hotfix.[0-9]+' # Hotfix: v1.2.3-hotfix.1

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Performance optimizations (Rust Performance Book)
  RUSTFLAGS: "-C target-cpu=x86-64-v2 -C link-arg=-fuse-ld=lld"
  CARGO_INCREMENTAL: 0  # Disable incremental for release builds (better LTO)

jobs:
  # éªŒè¯ç‰ˆæœ¬å·
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      release_type: ${{ steps.version.outputs.release_type }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version info
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "$VERSION" =~ (alpha|beta|rc|hotfix) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            
            # æå–å‘å¸ƒç±»åž‹
            if [[ "$VERSION" =~ alpha ]]; then
              echo "release_type=Alpha" >> $GITHUB_OUTPUT
            elif [[ "$VERSION" =~ beta ]]; then
              echo "release_type=Beta" >> $GITHUB_OUTPUT
            elif [[ "$VERSION" =~ rc ]]; then
              echo "release_type=Release Candidate" >> $GITHUB_OUTPUT
            elif [[ "$VERSION" =~ hotfix ]]; then
              echo "release_type=Hotfix" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "release_type=Stable" >> $GITHUB_OUTPUT
          fi
          
          echo "Version: $VERSION"
          echo "Is Prerelease: $([[ "$VERSION" =~ (alpha|beta|rc|hotfix) ]] && echo true || echo false)"
      
      - name: Check version matches Cargo.toml
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          
          # ç‰ˆæœ¬å¿…é¡»å®Œå…¨åŒ¹é…ï¼ˆåŒ…æ‹¬é¢„å‘å¸ƒåŽç¼€ï¼‰
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Version mismatch!"
            echo "   Cargo.toml: $CARGO_VERSION"
            echo "   Tag:        $TAG_VERSION"
            exit 1
          fi
          
          echo "âœ… Version matches: $CARGO_VERSION"

  # Note: Quality checks (fmt, clippy, test) are handled by ci.yml
  # Tags are created from commits that have already passed CI

  # æž„å»ºæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    name: Build (${{ matrix.target }})
    needs: [validate]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          # æœªæ¥å¯ä»¥æ·»åŠ  aarch64
          # - os: ubuntu-latest
          #   target: aarch64-unknown-linux-gnu
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwayland-dev \
            libmpv-dev \
            libgl1-mesa-dev \
            libegl1-mesa-dev \
            libxkbcommon-dev \
            libfontconfig1-dev \
            lld \
            clang
      
      - name: Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          # Enable caching for faster builds
          cache: true
      
      - name: Build release binaries (optimized)
        run: |
          echo "Building with optimized profile..."
          echo "RUSTFLAGS: $RUSTFLAGS"
          cargo build --release --workspace --target ${{ matrix.target }}
          
          # Display binary sizes
          echo "Binary sizes:"
          ls -lh target/${{ matrix.target }}/release/wayvid*
          du -h target/${{ matrix.target }}/release/wayvid*
      
      - name: Strip binaries
        run: |
          strip target/${{ matrix.target }}/release/wayvid-gui
          strip target/${{ matrix.target }}/release/wayvid-ctl
      
      - name: Create tarball
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../wayvid-${{ needs.validate.outputs.version }}-${{ matrix.target }}.tar.gz \
            wayvid-gui wayvid-ctl
          cd ../../..
          sha256sum wayvid-${{ needs.validate.outputs.version }}-${{ matrix.target }}.tar.gz > \
            wayvid-${{ needs.validate.outputs.version }}-${{ matrix.target }}.tar.gz.sha256
      
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: wayvid-binaries-${{ matrix.target }}
          path: |
            wayvid-*.tar.gz
            wayvid-*.tar.gz.sha256
          retention-days: 90

  # æž„å»º AppImage (å¤ç”¨ build job çš„äºŒè¿›åˆ¶)
  appimage:
    name: Build AppImage
    needs: [validate, build]
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: wayvid-binaries-x86_64-unknown-linux-gnu
          path: artifacts
      
      - name: Prepare binaries for packaging
        run: |
          mkdir -p target/release
          # Extract tarballs produced by the build job into target/release
          for f in artifacts/*.tar.gz; do
            if [ -f "$f" ]; then
              tar -xzf "$f" -C target/release || true
            fi
          done
          # Fallback: if artifacts contain raw binaries, copy them
          shopt -s nullglob || true
          cp artifacts/* target/release/ 2>/dev/null || true
          chmod +x target/release/* || true
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            upx-ucl \
            imagemagick \
            fuse \
            libfuse2
      
      - name: Download appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage \
            -O /tmp/appimagetool
          chmod +x /tmp/appimagetool
          sudo mv /tmp/appimagetool /usr/local/bin/appimagetool
      
      - name: Build AppImage (using precompiled binaries)
        run: |
          cd packaging/appimage
          chmod +x build-appimage.sh
          # Use NO_BUILD=1 to skip compilation and use precompiled binaries from target/release
          NO_BUILD=1 ./build-appimage.sh ${{ needs.validate.outputs.version }}
      
      - name: Verify AppImage exists
        run: |
          ls -lh packaging/appimage/build/wayvid-${{ needs.validate.outputs.version }}-x86_64.AppImage
          echo "âœ… AppImage created successfully"
          # Skip runtime tests in CI (requires display/Wayland)
      
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: wayvid-appimage
          path: |
            packaging/appimage/build/wayvid-*.AppImage
            packaging/appimage/build/SHA256SUMS
          retention-days: 90

  # æž„å»º Debian åŒ… (å¤ç”¨ build job çš„äºŒè¿›åˆ¶)
  build-deb-package:
    name: Build Debian Package
    needs: [validate, build]
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: wayvid-binaries-x86_64-unknown-linux-gnu
          path: artifacts
      
      - name: Prepare binaries for packaging
        run: |
          mkdir -p target/release
          for f in artifacts/*.tar.gz; do
            if [ -f "$f" ]; then
              tar -xzf "$f" -C target/release || true
            fi
          done
          cp artifacts/* target/release/ 2>/dev/null || true
          chmod +x target/release/* || true
      
      - name: Install cargo-deb
        run: |
          cargo install cargo-deb --version 2.8.0 --locked
      
      - name: Build .deb package (reusing binaries)
        run: cargo deb --no-build --no-strip --verbose
      
      - name: Generate checksum
        run: |
          cd target/debian
          sha256sum *.deb > wayvid_${{ needs.validate.outputs.version }}_amd64.deb.sha256
      
      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: wayvid-deb-package
          path: |
            target/debian/*.deb
            target/debian/*.sha256
          retention-days: 90

  # ç”Ÿæˆ Release Notes å’Œæ›´æ–° CHANGELOG
  release-notes:
    name: Generate Release Notes
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      notes: ${{ steps.notes.outputs.notes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install git-cliff
        run: |
          wget -q https://github.com/orhun/git-cliff/releases/download/v2.6.1/git-cliff-2.6.1-x86_64-unknown-linux-gnu.tar.gz
          tar xzf git-cliff-2.6.1-x86_64-unknown-linux-gnu.tar.gz
          sudo mv git-cliff-2.6.1/git-cliff /usr/local/bin/
          git-cliff --version
      
      - name: Generate CHANGELOG for this release
        id: changelog
        run: |
          # ç”Ÿæˆä»Žä¸Šä¸€ä¸ª tag åˆ°å½“å‰ tag çš„ changelog
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release - generating full changelog"
            git-cliff --latest --strip header -o current_release.md
          else
            echo "Generating changelog from $PREVIOUS_TAG to current"
            git-cliff --current --strip header -o current_release.md
          fi
          
          cat current_release.md
      
      - name: Build complete release notes
        id: notes
        run: |
          # æž„å»ºåŒ…å«å®‰è£…è¯´æ˜Žçš„å®Œæ•´ release notes
          cat > release_notes.md << 'EOF'
          ## wayvid ${{ needs.validate.outputs.version }}
          
          **Release Type:** ${{ needs.validate.outputs.release_type }}
          **Build Date:** $(date -u +%Y-%m-%d)
          
          EOF
          
          # æ·»åŠ  changelog å†…å®¹
          cat current_release.md >> release_notes.md
          
          # æ·»åŠ å®‰è£…è¯´æ˜Ž
          cat >> release_notes.md << 'EOF'
          
          ---
          
          ### ðŸ“¦ Installation
          
          #### AppImage (Recommended)
          ```bash
          # Download
          wget https://github.com/YangYuS8/wayvid/releases/download/v${{ needs.validate.outputs.version }}/wayvid-${{ needs.validate.outputs.version }}-x86_64.AppImage
          chmod +x wayvid-${{ needs.validate.outputs.version }}-x86_64.AppImage
          
          # Run
          ./wayvid-${{ needs.validate.outputs.version }}-x86_64.AppImage
          ./wayvid-${{ needs.validate.outputs.version }}-x86_64.AppImage gui
          ```
          
          #### Binary Tarball
          ```bash
          # Download
          wget https://github.com/YangYuS8/wayvid/releases/download/v${{ needs.validate.outputs.version }}/wayvid-${{ needs.validate.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz
          tar xzf wayvid-${{ needs.validate.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz
          
          # Install
          sudo mv wayvid wayvid-ctl wayvid-gui /usr/local/bin/
          ```
          
          #### Arch Linux (AUR)
          ```bash
          yay -S wayvid
          ```
          
          #### Debian/Ubuntu
          ```bash
          # Download
          wget https://github.com/YangYuS8/wayvid/releases/download/v${{ needs.validate.outputs.version }}/wayvid_${{ needs.validate.outputs.version }}_amd64.deb
          
          # Install
          sudo dpkg -i wayvid_${{ needs.validate.outputs.version }}_amd64.deb
          sudo apt-get install -f  # Install dependencies if needed
          ```
          
          ### ðŸ“‹ Checksums
          
          See `SHA256SUMS` file for checksums of all release artifacts.
          
          ### ðŸ”— Links
          
          - [Documentation](https://github.com/YangYuS8/wayvid/blob/main/README.md)
          - [Full Changelog](https://github.com/YangYuS8/wayvid/blob/main/CHANGELOG.md)
          EOF
          
          cat release_notes.md
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Update CHANGELOG.md
        run: |
          # ç”Ÿæˆå®Œæ•´çš„ CHANGELOG.md
          git-cliff -o CHANGELOG.md
          cat CHANGELOG.md
      
      - name: Upload CHANGELOG
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md
          retention-days: 90
      
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.md
          retention-days: 90

  # åˆ›å»º GitHub Release
  release:
    name: Create Release
    needs: [validate, build, appimage, build-deb-package, release-notes]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Prepare release files
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.tar.gz" -o -name "*.sha256" -o -name "*.AppImage" -o -name "*.deb" -o -name "SHA256SUMS" -o -name "CHANGELOG.md" \) -exec cp {} release-files/ \;
          ls -lh release-files/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: wayvid ${{ needs.validate.outputs.version }}
          body_path: release-artifacts/release-notes/release_notes.md
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          draft: false
          files: release-files/*
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_unmatched_files: true

  # æ›´æ–° AUR ç¨³å®šç‰ˆåŒ…ï¼ˆä»…æ­£å¼ç‰ˆï¼‰
  update-aur-stable:
    name: Update AUR Stable Package
    needs: [validate, release]
    if: needs.validate.outputs.is_prerelease == 'false'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Prepare PKGBUILD
        run: |
          # Update version in PKGBUILD.stable (binary package mode)
          VERSION="${{ needs.validate.outputs.version }}"
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" packaging/aur/PKGBUILD.stable
          
          # Binary package uses SKIP for checksum (downloaded from GitHub Release)
          # No need to calculate SHA256, pacman will verify the package signature
          
          # Prepare for AUR
          mkdir -p aur-package
          cp packaging/aur/PKGBUILD.stable aur-package/PKGBUILD
          
      - name: Generate .SRCINFO
        run: |
          cd aur-package
          docker run --rm -v "$(pwd):/pkg" archlinux:latest bash -c "
            useradd -m builder
            pacman -Syu --noconfirm
            pacman -S --noconfirm binutils fakeroot
            cd /pkg
            chown -R builder:builder /pkg
            su - builder -c 'cd /pkg && makepkg --printsrcinfo' > .SRCINFO
          "
          cat .SRCINFO
        
      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: wayvid
          pkgbuild: aur-package/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to v${{ needs.validate.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519

  # æ›´æ–° AUR Git åŒ…ï¼ˆä»…é¢„å‘å¸ƒç‰ˆï¼‰
  update-aur-git:
    name: Update AUR Git Package
    needs: [validate, release]
    if: needs.validate.outputs.is_prerelease == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Update PKGBUILD for git version
        run: |
          # Copy git PKGBUILD
          mkdir -p aur-git-package
          cp packaging/aur/PKGBUILD aur-git-package/PKGBUILD
          
          # Update pkgrel to trigger rebuild (increment by 1)
          cd aur-git-package
          CURRENT_REL=$(grep '^pkgrel=' PKGBUILD | sed 's/pkgrel=//')
          NEW_REL=$((CURRENT_REL + 1))
          sed -i "s/^pkgrel=.*/pkgrel=$NEW_REL/" PKGBUILD
          
          echo "Updated pkgrel from $CURRENT_REL to $NEW_REL"
          cat PKGBUILD
          
      - name: Generate .SRCINFO
        run: |
          cd aur-git-package
          docker run --rm -v "$(pwd):/pkg" archlinux:latest bash -c "
            useradd -m builder
            pacman -Syu --noconfirm
            pacman -S --noconfirm binutils fakeroot git
            cd /pkg
            chown -R builder:builder /pkg
            su - builder -c 'cd /pkg && makepkg --printsrcinfo' > .SRCINFO
          "
          cat .SRCINFO
        
      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: wayvid-git
          pkgbuild: aur-git-package/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update for prerelease v${{ needs.validate.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
