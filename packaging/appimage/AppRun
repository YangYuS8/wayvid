#!/bin/bash
# AppRun script for wayvid AppImage

# Get the AppDir path
APPDIR="$(dirname "$(readlink -f "${0}")")"

# Set up library paths
export LD_LIBRARY_PATH="${APPDIR}/usr/lib:${LD_LIBRARY_PATH}"
export PATH="${APPDIR}/usr/bin:${PATH}"

# Set up XDG paths for configuration
export XDG_DATA_DIRS="${APPDIR}/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

# Detect which binary to run based on argv[0] or first argument
BINARY_NAME="$(basename "$0")"

case "$BINARY_NAME" in
    wayvid-ctl|wayvid-ctl.AppImage)
        exec "${APPDIR}/usr/bin/wayvid-ctl" "$@"
        ;;
    wayvid-gui|wayvid-gui.AppImage)
        exec "${APPDIR}/usr/bin/wayvid-gui" "$@"
        ;;
    wayvid|wayvid.AppImage|AppRun)
        # Check if first argument is a subcommand
        case "$1" in
            ctl)
                shift
                exec "${APPDIR}/usr/bin/wayvid-ctl" "$@"
                ;;
            gui)
                shift
                if [ -x "${APPDIR}/usr/bin/wayvid-gui" ]; then
                    exec "${APPDIR}/usr/bin/wayvid-gui" "$@"
                else
                    echo "Error: wayvid-gui not included in this AppImage" >&2
                    echo "Rebuild with: cargo build --release --all-features" >&2
                    exit 1
                fi
                ;;
            *)
                exec "${APPDIR}/usr/bin/wayvid" "$@"
                ;;
        esac
        ;;
    *)
        exec "${APPDIR}/usr/bin/wayvid" "$@"
        ;;
esac
