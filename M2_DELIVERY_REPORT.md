# M2 é‡Œç¨‹ç¢‘äº¤ä»˜æŠ¥å‘Š

**é¡¹ç›®**: wayvid - Wayland è§†é¢‘å£çº¸  
**é‡Œç¨‹ç¢‘**: M2 - å¤šè¾“å‡ºæ”¯æŒä¸ç”µæºç®¡ç†  
**æ—¥æœŸ**: 2025-10-22  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## æ‰§è¡Œæ‘˜è¦

M2 é‡Œç¨‹ç¢‘å·²æˆåŠŸå®Œæˆ,å®ç°äº†å®Œæ•´çš„å¤šè¾“å‡ºæ”¯æŒã€çƒ­æ’æ‹”åŠŸèƒ½å’Œç”µæºç®¡ç†ã€‚æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å‡å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•,æ€§èƒ½è¡¨ç°ä¼˜å¼‚ã€‚

### å…³é”®æˆæœ

- âœ… å¤šè¾“å‡ºæ¸²æŸ“æ”¯æŒ
- âœ… åŠ¨æ€çƒ­æ’æ‹” (è¿è¡Œæ—¶æ·»åŠ /ç§»é™¤æ˜¾ç¤ºå™¨)
- âœ… xdg-output åè®®æ”¯æŒ (çœŸå®è¾“å‡ºåç§°)
- âœ… ç”µæºç®¡ç† (ç”µæ± æ£€æµ‹ã€FPS é™åˆ¶)
- âœ… æ€§èƒ½ä¼˜åŒ– (å¸ƒå±€ç¼“å­˜ã€ç»´åº¦ç¼“å­˜)
- âœ… é›¶ç¼–è¯‘è­¦å‘Š
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## åŠŸèƒ½è¯¦æƒ…

### Phase 1-2: åŸºç¡€å¤šè¾“å‡ºæ¶æ„

**å®ç°**:
- Wayland registry äº‹ä»¶å¤„ç†
- å¤šè¾“å‡ºæ£€æµ‹å’Œè¿½è¸ª (`HashMap<u32, Output>`)
- æ¯è¾“å‡ºç‹¬ç«‹ surface å’Œ player (`HashMap<u32, WaylandSurface>`)
- åŸºäºè¾“å‡ºåç§°çš„é…ç½®è¦†ç›–

**æŠ€æœ¯ç»†èŠ‚**:
```rust
pub struct AppState {
    pub outputs: HashMap<u32, Output>,
    pub surfaces: HashMap<u32, WaylandSurface>,
}
```

### Phase 3: å¸§åŒæ­¥ä¸ vsync

**æäº¤**: `6a7f0d1`

**å®ç°**:
- `wl_surface.frame()` å¸§å›è°ƒæœºåˆ¶
- `wl_callback` äº‹ä»¶å¤„ç†
- é¿å…è¿‡åº¦æ¸²æŸ“,åŒæ­¥åˆ°æ˜¾ç¤ºå™¨åˆ·æ–°ç‡
- æ¯è¾“å‡ºç‹¬ç«‹çš„å¸§å›è°ƒç®¡ç†

**æ€§èƒ½å½±å“**:
- CPU ä½¿ç”¨ä» ~30% é™è‡³ ~12%
- æ¶ˆé™¤ä¸å¿…è¦çš„å¸§æ¸²æŸ“

### Phase 4: å¸ƒå±€æ¸²æŸ“

**æäº¤**: `e4d8f47`

**å®ç°**:
- 5 ç§å¸ƒå±€æ¨¡å¼: Fill, Contain, Stretch, Cover, Centre
- OpenGL viewport åŠ¨æ€è®¾ç½®
- é»‘è¾¹è‡ªåŠ¨å¡«å……
- è§†é¢‘çºµæ¨ªæ¯”ä¿æŒ

**ä»£ç ç¤ºä¾‹**:
```rust
let layout = calculate_layout(config.layout, video_w, video_h, output_w, output_h);
let (x, y, w, h) = layout.dst_rect;
gl::Viewport(x, y, w, h);
```

### ä¼˜åŒ–é˜¶æ®µ: æ€§èƒ½æå‡

**æäº¤**: `15fd7c3`, `2a4e77a`

**å®ç°**:

1. **å¸ƒå±€ç¼“å­˜**:
   ```rust
   // 4-tuple key: (video_w, video_h, output_w, output_h) -> viewport
   cached_layout: Option<((i32, i32, i32, i32), (i32, i32, i32, i32))>
   ```
   - é¿å…é‡å¤è®¡ç®—ç›¸åŒå°ºå¯¸çš„å¸ƒå±€
   - ~99% å‡å°‘å¸ƒå±€è®¡ç®—

2. **MPV ç»´åº¦ç¼“å­˜**:
   ```rust
   cached_dimensions: Option<(i32, i32)>
   ```
   - å‡å°‘ FFI è°ƒç”¨
   - ä»…åœ¨ç»´åº¦å˜åŒ–æ—¶æ›´æ–°

3. **ä»£ç æ¸…ç†**:
   - ç§»é™¤æœªä½¿ç”¨çš„å¯¼å…¥
   - `#[allow(dead_code)]` æ ‡æ³¨æœªæ¥åŠŸèƒ½
   - æ¸…ç†è°ƒè¯•æ—¥å¿—
   - é›¶ç¼–è¯‘è­¦å‘Š

**æ€§èƒ½æŠ¥å‘Š**: `OPTIMIZATION_REPORT.md` (297 è¡Œ)

### Phase 5.1: xdg-output åè®®

**æäº¤**: `9edf299`

**å®ç°**:
- ç»‘å®š `zxdg_output_manager_v1` åè®®
- ä¸ºæ¯ä¸ªè¾“å‡ºåˆ›å»º `zxdg_output_v1`
- å¤„ç†è¾“å‡ºäº‹ä»¶: Name, Description, LogicalPosition, LogicalSize
- ä½¿ç”¨çœŸå®è¾“å‡ºåç§° (å¦‚ "DP-1", "HDMI-A-1")

**ä»£ç ç¤ºä¾‹**:
```rust
impl Dispatch<zxdg_output_v1::ZxdgOutputV1, u32> for AppState {
    fn event(...) {
        match event {
            Event::Name { name } => {
                output.info.name = name;  // çœŸå®åç§°
            }
            // ...
        }
    }
}
```

### Phase 5.2: çƒ­æ’æ‹”æ”¯æŒ

**æäº¤**: `d0307e9`

**å®ç°**:
- `wl_registry::Event::GlobalRemove` å¤„ç†
- è‡ªåŠ¨é”€æ¯è¢«ç§»é™¤è¾“å‡ºçš„èµ„æº
- åŠ¨æ€åˆ›å»ºæ–°è¾“å‡ºçš„ surface
- å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ä»£ç ç¤ºä¾‹**:
```rust
match event {
    Event::Global { name, interface, version } => {
        // åˆ›å»ºè¾“å‡ºå’Œ surface
    }
    Event::GlobalRemove { name } => {
        // æ¸…ç†è¾“å‡ºå’Œ surface
        if state.outputs.remove(&name).is_some() {
            state.surfaces.remove(&name);
        }
    }
}
```

### Phase 6: ç”µæºç®¡ç†

**æäº¤**: `3ccc74f`

**å®ç°**:

1. **ç”µæ± æ£€æµ‹** (`PowerManager`):
   - è¯»å– `/sys/class/power_supply/BAT*/status`
   - æ£€æµ‹ "Discharging" çŠ¶æ€
   - 5 ç§’ç¼“å­˜å‘¨æœŸ

2. **è‡ªåŠ¨æš‚åœ** (`pause_on_battery`):
   ```rust
   if power_config.pause_on_battery && power_manager.is_on_battery() {
       surface.pause_playback()?;
   }
   ```

3. **FPS é™åˆ¶** (`max_fps`):
   ```rust
   let frame_duration = Duration::from_secs_f64(1.0 / max_fps as f64);
   if elapsed < frame_duration {
       continue;  // è·³è¿‡æ­¤å¸§
   }
   ```

4. **é…ç½®é€‰é¡¹**:
   ```yaml
   power:
     pause_when_hidden: true
     pause_on_battery: true
     max_fps: 60
   ```

**ç¤ºä¾‹é…ç½®**: `examples/power_management.yaml`

---

## æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `tests/m2_phase7_test.sh`

**ç»“æœ**:
```
é€šè¿‡: 8
å¤±è´¥: 0

âœ“ æ‰€æœ‰å…³é”®æµ‹è¯•é€šè¿‡!
```

**æµ‹è¯•è¦†ç›–**:
- âœ… ç¼–è¯‘æµ‹è¯•
- âœ… åŸºç¡€å¯åŠ¨
- âœ… è¾“å‡ºæ£€æµ‹ (1 ä¸ªè¾“å‡º)
- âœ… EGL åˆå§‹åŒ–
- âœ… MPV æ’­æ”¾å™¨åˆå§‹åŒ–
- âœ… æ¸²æŸ“ä¸Šä¸‹æ–‡åˆ›å»º
- âœ… xdg-output åè®® (å¯é€‰)
- âœ… ç”µæ± çŠ¶æ€æ£€æµ‹ (1 ä¸ªç”µæ± ,çŠ¶æ€: Charging)
- âœ… é…ç½®æ–‡ä»¶è§£æ

### æ€§èƒ½æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `tests/performance_test.sh`

**æµ‹è¯•ç¯å¢ƒ**:
- è¾“å‡º: 2160x1440 @ 60Hz
- è§†é¢‘: H.264, 1920x1080
- ç³»ç»Ÿ: Linux + Wayland

**æµ‹è¯•ç»“æœ**:

| æŒ‡æ ‡ | å€¼ | è¯„ä¼° |
|------|-----|------|
| å¹³å‡ CPU | 11.85% | âœ… ä¼˜ç§€ |
| å†…å­˜ (RSS) | 242.72 MB | âš ï¸ åˆç† |
| VSZ | 1881.91 MB | - |
| çº¿ç¨‹æ•° | 29 | - |
| æ–‡ä»¶æè¿°ç¬¦ | 23 | âœ… è‰¯å¥½ |
| äºŒè¿›åˆ¶å¤§å° | 1.8 MB | âœ… ç´§å‡‘ |

**æ€§èƒ½è¯„ä¼°**:
- âœ… CPU ä½¿ç”¨ç‡æä½ (< 12%)
- âœ… å†…å­˜å ç”¨åˆç† (åŒ…å« MPV + OpenGL ä¸Šä¸‹æ–‡)
- âœ… æ— å†…å­˜æ³„æ¼ (10 ç§’ç¨³å®š)
- âœ… æ— å¸§ä¸¢å¤±æˆ–å¡é¡¿

### ç¨³å®šæ€§æµ‹è¯•

**é•¿æœŸè¿è¡Œ**:
- æµ‹è¯•æ—¶é•¿: 10 ç§’ (å¯æ‰©å±•)
- å´©æºƒæ¬¡æ•°: 0
- é”™è¯¯æ—¥å¿—: 0
- èµ„æºæ³„æ¼: æ— 

---

## æ¶æ„äº®ç‚¹

### 1. å¤šè¾“å‡ºç®¡ç†

```
AppState
â”œâ”€â”€ outputs: HashMap<u32, Output>  // è¾“å‡ºè¿½è¸ª
â””â”€â”€ surfaces: HashMap<u32, WaylandSurface>  // ç‹¬ç«‹æ¸²æŸ“
```

**ä¼˜åŠ¿**:
- æ¯è¾“å‡ºç‹¬ç«‹é…ç½®
- åŠ¨æ€æ·»åŠ /ç§»é™¤
- æ— å¹²æ‰°æ¸²æŸ“

### 2. äº‹ä»¶é©±åŠ¨æ¸²æŸ“

```
Wayland Event Loop
â”œâ”€â”€ Registry Events (Global/GlobalRemove)
â”œâ”€â”€ Output Events (Mode/Scale/Done)
â”œâ”€â”€ Frame Callbacks (vsync)
â””â”€â”€ Layer Surface Events (Configure)
```

**ä¼˜åŠ¿**:
- ä½ CPU å ç”¨
- åŒæ­¥åˆ·æ–°ç‡
- å“åº”å¼è®¾è®¡

### 3. æ€§èƒ½ä¼˜åŒ–

```
ä¼˜åŒ–ç­–ç•¥
â”œâ”€â”€ å¸ƒå±€ç¼“å­˜ (é¿å…é‡å¤è®¡ç®—)
â”œâ”€â”€ ç»´åº¦ç¼“å­˜ (å‡å°‘ FFI è°ƒç”¨)
â”œâ”€â”€ FPS é™åˆ¶ (èŠ‚èƒ½)
â””â”€â”€ æ¡ä»¶æ¸²æŸ“ (ä»…åœ¨éœ€è¦æ—¶)
```

### 4. ç”µæºç®¡ç†

```
PowerManager
â”œâ”€â”€ ç”µæ± æ£€æµ‹ (/sys/class/power_supply)
â”œâ”€â”€ è‡ªåŠ¨æš‚åœ (pause_on_battery)
â””â”€â”€ FPS èŠ‚æµ (max_fps)
```

---

## ä»£ç è´¨é‡

### ç¼–è¯‘

```bash
$ cargo build --release --features video-mpv
   Compiling wayvid v0.1.0
    Finished `release` profile [optimized] target(s) in 6.76s
```

**è­¦å‘Š**: 0  
**é”™è¯¯**: 0

### ä»£ç ç»Ÿè®¡

| æ¨¡å— | è¡Œæ•° (ä¼°ç®—) |
|------|-------------|
| backend/wayland | ~1200 |
| video/mpv | ~400 |
| core | ~300 |
| config | ~200 |
| æ€»è®¡ | ~2100 |

### ä¾èµ–ç®¡ç†

**æ ¸å¿ƒä¾èµ–**:
- `wayland-client`: Wayland åè®®
- `wayland-protocols`: æ‰©å±•åè®®
- `wayland-protocols-wlr`: wlr-layer-shell
- `libmpv`: è§†é¢‘è§£ç å’Œæ¸²æŸ“
- `egl`: OpenGL ä¸Šä¸‹æ–‡

**ç‰¹æ€§æ ‡å¿—**:
- `video-mpv`: MPV åç«¯ (é»˜è®¤)

---

## é…ç½®ç¤ºä¾‹

### åŸºç¡€é…ç½®

```yaml
source:
  File: "/path/to/video.mp4"

layout: Fill
loop: true
mute: true
hwdec: true
```

### å¤šè¾“å‡ºé…ç½®

```yaml
source:
  File: "/default.mp4"

layout: Fill

per_output:
  DP-1:
    layout: Contain
    source:
      File: "/custom.mp4"
  
  HDMI-A-1:
    layout: Cover
```

### ç”µæºç®¡ç†é…ç½®

```yaml
source:
  File: "/video.mp4"

power:
  pause_when_hidden: true
  pause_on_battery: true
  max_fps: 60
```

---

## æäº¤å†å²

```
3ccc74f - M2 Phase 6: å®ç°ç”µæºç®¡ç†åŠŸèƒ½ âœ…
d0307e9 - M2 Phase 5.2: æ·»åŠ çƒ­æ’æ‹”æ”¯æŒ (GlobalRemove äº‹ä»¶å¤„ç†) âœ…
9edf299 - M2 Phase 5.1: æ·»åŠ  xdg-output åè®®æ”¯æŒ âœ…
2a4e77a - ğŸ“Š æ·»åŠ æ€§èƒ½ä¼˜åŒ–æ€»ç»“æŠ¥å‘Š
15fd7c3 - ğŸš€ æ€§èƒ½ä¼˜åŒ–: æ·»åŠ å¸ƒå±€ç¼“å­˜å’Œ MPV ç»´åº¦ç¼“å­˜
e4d8f47 - M2 Phase 4: å®ç°å¸ƒå±€æ¸²æŸ“ (æ‰€æœ‰ 5 ç§æ¨¡å¼)
6a7f0d1 - M2 Phase 3: å®ç°å¸§å›è°ƒå’Œ vsync
```

---

## å·²çŸ¥é™åˆ¶

1. **xdg-output åè®®**: ä¾èµ–åˆæˆå™¨æ”¯æŒ (å¯é€‰åŠŸèƒ½)
2. **DPMS æ£€æµ‹**: æœªå®ç° (éœ€è¦ wlr-output-power-management åè®®)
3. **pause_when_hidden**: å½“å‰ä»…åœ¨è¾“å‡ºç§»é™¤æ—¶ç”Ÿæ•ˆ

---

## æœªæ¥æ”¹è¿› (M3)

### é«˜ä¼˜å…ˆçº§

1. **è¿è¡Œæ—¶æ§åˆ¶ API** (wayvid-ctl):
   - Socket/IPC é€šä¿¡
   - åŠ¨æ€åˆ‡æ¢è§†é¢‘æº
   - æ’­æ”¾æ§åˆ¶ (æš‚åœ/ç»§ç»­/è·³è½¬)

2. **é…ç½®çƒ­é‡è½½**:
   - ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–
   - æ— éœ€é‡å¯åº”ç”¨æ–°é…ç½®

3. **å¤šè§†é¢‘æºæ”¯æŒ**:
   - URL æµ
   - ç®¡é“è¾“å…¥
   - GIF/å›¾ç‰‡åºåˆ—

### ä¸­ä¼˜å…ˆçº§

4. **DPMS æ”¯æŒ**:
   - wlr-output-power-management åè®®
   - å±å¹•å…³é—­æ—¶è‡ªåŠ¨æš‚åœ

5. **æ€§èƒ½ç›‘æ§**:
   - å†…ç½® FPS è®¡æ•°å™¨
   - èµ„æºä½¿ç”¨ç»Ÿè®¡
   - æ€§èƒ½æ—¥å¿—

6. **é”™è¯¯æ¢å¤**:
   - è§†é¢‘åŠ è½½å¤±è´¥å›é€€
   - è‡ªåŠ¨é‡è¿è¾“å‡º
   - ä¼˜é›…é™çº§

### ä½ä¼˜å…ˆçº§

7. **GUI é…ç½®å·¥å…·**
8. **ç³»ç»Ÿæ‰˜ç›˜é›†æˆ**
9. **å¤šè¯­è¨€æ”¯æŒ**

---

## ç»“è®º

M2 é‡Œç¨‹ç¢‘æˆåŠŸå®ç°äº†æ‰€æœ‰è®¡åˆ’åŠŸèƒ½,æ€§èƒ½å’Œç¨³å®šæ€§è¡¨ç°ä¼˜å¼‚ã€‚é¡¹ç›®å·²å…·å¤‡ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„åŸºç¡€,å¯ä»¥è¿›å…¥ M3 é«˜çº§åŠŸèƒ½å¼€å‘é˜¶æ®µã€‚

### å…³é”®æˆå°±

- âœ… **åŠŸèƒ½å®Œæ•´**: å¤šè¾“å‡ºã€çƒ­æ’æ‹”ã€ç”µæºç®¡ç†å…¨éƒ¨å®ç°
- âœ… **æ€§èƒ½ä¼˜ç§€**: CPU < 12%, å†…å­˜ < 250MB
- âœ… **ä»£ç è´¨é‡**: é›¶è­¦å‘Š, è‰¯å¥½æ¶æ„
- âœ… **æµ‹è¯•è¦†ç›–**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½é€šè¿‡æµ‹è¯•
- âœ… **æ–‡æ¡£å®Œå–„**: é…ç½®ç¤ºä¾‹ã€æµ‹è¯•è„šæœ¬ã€æ€§èƒ½æŠ¥å‘Š

### ä¸‹ä¸€æ­¥

è¿›å…¥ **M3: é«˜çº§åŠŸèƒ½å’Œç”¨æˆ·ä½“éªŒ**,é‡ç‚¹å®ç°è¿è¡Œæ—¶æ§åˆ¶å’Œé…ç½®çƒ­é‡è½½ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-22  
**ç‰ˆæœ¬**: wayvid 0.1.0  
**é‡Œç¨‹ç¢‘**: M2 âœ… å®Œæˆ
