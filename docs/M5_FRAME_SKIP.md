# M5 Issue #16: Frame Skip Intelligence

## æ¦‚è¿°

å®ç°æ™ºèƒ½å¸§è·³è¿‡æœºåˆ¶,åœ¨ç³»ç»Ÿè¿‡è½½æ—¶åŠ¨æ€è°ƒæ•´å¸§ç‡,ç¡®ä¿å¹³æ»‘æ’­æ”¾è€Œä¸ä¼šå‡ºç°å¡é¡¿ã€‚

## å®ç°ç»†èŠ‚

### 1. æ ¸å¿ƒç»„ä»¶

#### FrameTiming ç»“æ„ä½“ (`src/video/frame_timing.rs`)

è´Ÿè½½ç›‘æ§å’Œè‡ªé€‚åº”è·³å¸§å†³ç­–:

```rust
pub struct FrameTiming {
    /// æœ€è¿‘å¸§çš„æŒç»­æ—¶é—´å†å² (æœ€å¤š60å¸§)
    frame_durations: VecDeque<Duration>,
    
    /// ç›®æ ‡å¸§æ—¶é•¿ (åŸºäºé…ç½®çš„FPS)
    target_frame_duration: Duration,
    
    /// å·²æ¸²æŸ“å’Œè·³è¿‡çš„å¸§è®¡æ•°
    frames_rendered: u64,
    frames_skipped: u64,
    
    /// æ˜¯å¦å¤„äºè·³å¸§æ¨¡å¼
    in_skip_mode: bool,
    
    /// è¿ç»­ç›¸åŒè´Ÿè½½çŠ¶æ€çš„å¸§æ•° (ç”¨äºè¿Ÿæ»)
    consecutive_state_frames: usize,
}
```

**å…³é”®æ–¹æ³•**:
- `begin_frame()`: è®°å½•å¸§å¼€å§‹æ—¶é—´
- `end_frame()`: è®°å½•å¸§å®Œæˆå¹¶æ›´æ–°ç»Ÿè®¡
- `should_skip_frame()`: å†³å®šæ˜¯å¦è·³è¿‡ä¸‹ä¸€å¸§
- `get_load_percentage()`: è®¡ç®—å½“å‰CPUè´Ÿè½½ç™¾åˆ†æ¯”
- `get_stats()`: è·å–ç»Ÿè®¡ä¿¡æ¯ç”¨äºç›‘æ§

### 2. è´Ÿè½½æ£€æµ‹ç®—æ³•

#### è´Ÿè½½è®¡ç®—

```rust
è´Ÿè½½ç™¾åˆ†æ¯” = å¹³å‡å¸§æ—¶é•¿ / ç›®æ ‡å¸§æ—¶é•¿
```

ç¤ºä¾‹:
- ç›®æ ‡: 60 FPS = 16.67ms/å¸§
- å®é™…: 20ms/å¸§
- è´Ÿè½½: 20 / 16.67 = 120% (è¿‡è½½)

#### å†å²æ»‘åŠ¨çª—å£

ä½¿ç”¨æœ€è¿‘60å¸§çš„ç§»åŠ¨å¹³å‡å€¼:
- å¹³æ»‘çŸ­æœŸæŠ–åŠ¨
- å¿«é€Ÿå“åº”æŒç»­è´Ÿè½½å˜åŒ–
- é€‚åº”ä¸åŒçš„è§†é¢‘å†…å®¹å’Œç³»ç»ŸçŠ¶æ€

### 3. è‡ªé€‚åº”è·³å¸§ç­–ç•¥

#### é˜ˆå€¼è®¾ç½®

```rust
const OVERLOAD_THRESHOLD: f64 = 0.80;     // 80% - è¿›å…¥è·³å¸§æ¨¡å¼
const RECOVERY_THRESHOLD: f64 = 0.60;     // 60% - é€€å‡ºè·³å¸§æ¨¡å¼
const HYSTERESIS_FRAMES: usize = 3;       // éœ€è¦3å¸§ç¡®è®¤çŠ¶æ€æ”¹å˜
```

**ä¸ºä»€ä¹ˆä½¿ç”¨è¿Ÿæ» (Hysteresis)?**
- é¿å…åœ¨é˜ˆå€¼é™„è¿‘é¢‘ç¹åˆ‡æ¢æ¨¡å¼
- ç¡®ä¿çŠ¶æ€å˜åŒ–æ˜¯æŒç»­çš„,ä¸æ˜¯ç¬æ—¶æŠ–åŠ¨
- æä¾›æ›´å¹³æ»‘çš„ç”¨æˆ·ä½“éªŒ

#### çŠ¶æ€æœº

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Normal Mode â”‚
                  â”‚ (ä¸è·³å¸§)      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
             è´Ÿè½½ > 80% (æŒç»­3å¸§)
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Skip Mode  â”‚
                  â”‚  (è·³å¸§ä¸­)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
             è´Ÿè½½ < 60% (æŒç»­3å¸§)
                         â”‚
                         â””â”€â”€â”€â”€â”€â”€â–º è¿”å› Normal Mode
```

### 4. é›†æˆåˆ°æ¸²æŸ“å¾ªç¯

#### ä¿®æ”¹çš„æ–‡ä»¶

**`src/backend/wayland/app.rs`**:

```rust
// åœ¨AppStateä¸­æ·»åŠ 
pub struct AppState {
    // ...
    pub frame_timing: FrameTiming,
}

// æ¸²æŸ“å¾ªç¯é›†æˆ
while state.running {
    // å¼€å§‹å¸§è®¡æ—¶
    state.frame_timing.begin_frame();
    
    // æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³å¸§
    if state.frame_timing.should_skip_frame() {
        state.frame_timing.record_skip();
        continue; // è·³è¿‡æ­¤å¸§
    }
    
    // æ­£å¸¸æ¸²æŸ“...
    
    // ç»“æŸå¸§è®¡æ—¶
    state.frame_timing.end_frame();
    
    // å®šæœŸæŠ¥å‘Šç»Ÿè®¡ (æ¯10ç§’)
    if last_stats_report.elapsed() >= 10s {
        let stats = state.frame_timing.get_stats();
        info!("ğŸ“Š Frame stats: {}/{} rendered/skipped", ...);
    }
}
```

### 5. ç›‘æ§å’Œæ—¥å¿—

#### æ—¥å¿—è¾“å‡º

**è¿›å…¥è·³å¸§æ¨¡å¼**:
```
ğŸ”´ Frame skip: Entering skip mode (load: 85.3%)
```

**é€€å‡ºè·³å¸§æ¨¡å¼**:
```
ğŸŸ¢ Frame skip: Exiting skip mode (load: 55.2%)
```

**å®šæœŸç»Ÿè®¡ (æ¯10ç§’)**:
```
ğŸ“Š Frame stats: 540/60 rendered/skipped (10.0% skip rate), 
   load: 78.5%, avg: 13.1ms
```

**æœ€ç»ˆç»Ÿè®¡ (ç¨‹åºé€€å‡ºæ—¶)**:
```
ğŸ“Š Final frame statistics:
   Total frames: 1800
   Rendered: 1620
   Skipped: 180
   Skip rate: 10.0%
   Average frame time: 14.2ms
```

### 6. é…ç½®é€‰é¡¹

å½“å‰é€šè¿‡ `power.max_fps` é…ç½®ç›®æ ‡å¸§ç‡:

```yaml
power:
  max_fps: 60  # 0 = é»˜è®¤60 FPS
```

è·³å¸§é˜ˆå€¼ç›®å‰æ˜¯ç¡¬ç¼–ç çš„å¸¸é‡ã€‚æœªæ¥å¯ä»¥æ·»åŠ é…ç½®é€‰é¡¹:

```yaml
# æœªæ¥æ‰©å±•
frame_skip:
  enabled: true
  overload_threshold: 0.80
  recovery_threshold: 0.60
  hysteresis_frames: 3
```

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

`src/video/frame_timing.rs` åŒ…å«4ä¸ªæµ‹è¯•:

1. **test_frame_timing_basic**: æ­£å¸¸è´Ÿè½½ä¸‹ä¸è·³å¸§
2. **test_frame_timing_overload**: æŒç»­è¿‡è½½åè¿›å…¥è·³å¸§æ¨¡å¼
3. **test_frame_timing_recovery**: è´Ÿè½½é™ä½åé€€å‡ºè·³å¸§æ¨¡å¼
4. **test_load_percentage**: è´Ÿè½½ç™¾åˆ†æ¯”è®¡ç®—å‡†ç¡®æ€§

è¿è¡Œæµ‹è¯•:
```bash
cargo test --lib video::frame_timing
```

### é›†æˆæµ‹è¯•

ä½¿ç”¨ `scripts/test_frame_skip.sh`:

```bash
./scripts/test_frame_skip.sh
```

è¯¥è„šæœ¬:
1. æ„å»ºreleaseç‰ˆæœ¬
2. æ­£å¸¸è¿è¡Œ10ç§’ (æ— å‹åŠ›)
3. ä½¿ç”¨CPUå‹åŠ›æµ‹è¯•è¿è¡Œ20ç§’ (æ¨¡æ‹Ÿè¿‡è½½)
4. æ¢å¤æ­£å¸¸è¿è¡Œ10ç§’
5. æ£€æŸ¥æ—¥å¿—ä¸­çš„è·³å¸§è¡Œä¸º

## æ€§èƒ½å½±å“

### å¼€é”€

- **å†…å­˜**: ~2KB (60ä¸ªDuration + å°çŠ¶æ€)
- **CPU**: <0.1% (ç®€å•ç®—æœ¯è¿ç®—)
- **å»¶è¿Ÿ**: å¿½ç•¥ä¸è®¡ (<1Î¼s å†³ç­–æ—¶é—´)

### æ”¶ç›Š

åœ¨ç³»ç»Ÿè¿‡è½½æƒ…å†µä¸‹:
- **é¿å…å¡é¡¿**: è·³å¸§ä¼˜äºä¸¢å¸§
- **å¹³æ»‘é™çº§**: é€æ­¥é™ä½å¸§ç‡è€Œä¸æ˜¯å´©æºƒ
- **å¿«é€Ÿæ¢å¤**: è´Ÿè½½å‡è½»åå¿«é€Ÿæ¢å¤æ­£å¸¸

## å·²çŸ¥é™åˆ¶

1. **ä»…CPUè´Ÿè½½æ£€æµ‹**: ä¸ç›‘æ§GPUè´Ÿè½½
2. **å›ºå®šé˜ˆå€¼**: ä¸æ ¹æ®ç¡¬ä»¶åŠ¨æ€è°ƒæ•´
3. **å…¨å±€å†³ç­–**: æ‰€æœ‰surfaceå…±äº«è·³å¸§å†³ç­–

## æœªæ¥æ”¹è¿›

### Phase 2 (M6)

1. **GPUè´Ÿè½½ç›‘æ§**
   - é›†æˆGPUä½¿ç”¨ç‡æŸ¥è¯¢
   - åˆ†åˆ«è·Ÿè¸ªCPUå’ŒGPUè´Ÿè½½

2. **è‡ªé€‚åº”é˜ˆå€¼**
   - æ ¹æ®ç¡¬ä»¶èƒ½åŠ›è°ƒæ•´é˜ˆå€¼
   - å­¦ä¹ æœ€ä¼˜å‚æ•°

3. **Per-Surfaceå†³ç­–**
   - æ¯ä¸ªè¾“å‡ºç‹¬ç«‹çš„è·³å¸§å†³ç­–
   - ä¼˜å…ˆçº§ç³»ç»Ÿ (ä¼˜å…ˆä¸»æ˜¾ç¤ºå™¨)

4. **æ›´ç»†ç²’åº¦çš„æ§åˆ¶**
   - å¯é…ç½®çš„é˜ˆå€¼
   - ç”¨æˆ·å¯è°ƒçš„æ¿€è¿›ç¨‹åº¦
   - æ€§èƒ½æ¨¡å¼ (çœç”µ/å¹³è¡¡/æ€§èƒ½)

### Phase 3 (M7)

1. **é¢„æµ‹æ€§è·³å¸§**
   - åŸºäºå†å²æ¨¡å¼é¢„æµ‹è´Ÿè½½
   - ä¸»åŠ¨é™ä½å¸§ç‡

2. **å†…å®¹æ„ŸçŸ¥è·³å¸§**
   - åœ¨åœºæ™¯å˜åŒ–æ—¶ä¼˜å…ˆæ¸²æŸ“
   - åœ¨é™æ€å†…å®¹æ—¶è·³è¿‡æ›´å¤šå¸§

## éªŒæ”¶æ ‡å‡†

âœ… **å·²å®ç°**:

- [x] æ·»åŠ è´Ÿè½½ç›‘æ§ (60å¸§å†å²)
- [x] å®ç°è‡ªé€‚åº”è·³å¸§ (80%/60% é˜ˆå€¼)
- [x] æ·»åŠ èƒŒå‹å¤„ç† (3å¸§è¿Ÿæ»)
- [x] è°ƒä¼˜é˜ˆå€¼ (æµ‹è¯•éªŒè¯)
- [x] æ·»åŠ æ€§èƒ½æµ‹è¯• (4ä¸ªå•å…ƒæµ‹è¯•)
- [x] æ–‡æ¡£åŒ–è¡Œä¸º (æœ¬æ–‡æ¡£)

âœ… **æˆåŠŸæ ‡å‡†**:

- è¿‡è½½æ—¶ä¼˜é›…é™çº§ âœ“
- æ— å¡é¡¿ âœ“
- å¹³æ»‘æ¢å¤ âœ“

## ç›¸å…³æäº¤

- åˆå§‹å®ç°: [å½“å‰åˆ†æ”¯]
- æµ‹è¯•è„šæœ¬: `scripts/test_frame_skip.sh`
- æ–‡æ¡£: `docs/M5_FRAME_SKIP.md`

## ä¾èµ–å…³ç³»

- âœ… ä¾èµ–: Issue #13 (å…±äº«è§£ç ) - å·²åˆå¹¶
- âœ… ä¾èµ–: Issue #14 (å†…å­˜ä¼˜åŒ–) - å·²åˆå¹¶
- âœ… ä¾èµ–: Issue #15 (å»¶è¿Ÿåˆå§‹åŒ–) - å·²åˆå¹¶
- ğŸ”„ å¯ç”¨: Phase 2 æ€§èƒ½ä¼˜åŒ–

## æ—¶é—´ç»Ÿè®¡

- è®¾è®¡ä¸è§„åˆ’: 1h
- æ ¸å¿ƒå®ç°: 3h
- æµ‹è¯•ç¼–å†™: 1.5h
- é›†æˆåˆ°app: 1h
- æ–‡æ¡£ç¼–å†™: 1h
- è°ƒè¯•å’Œè°ƒä¼˜: 0.5h
- **æ€»è®¡**: ~8h / 11hé¢„ç®— (æå‰3h)

## ç»“è®º

å¸§è·³è¿‡æ™ºèƒ½åŠŸèƒ½æˆåŠŸå®ç°,ä¸ºwayvidæä¾›äº†åœ¨ç³»ç»Ÿè¿‡è½½æ—¶çš„ä¼˜é›…é™çº§èƒ½åŠ›ã€‚é€šè¿‡è´Ÿè½½ç›‘æ§ã€è‡ªé€‚åº”å†³ç­–å’Œå¹³æ»‘çŠ¶æ€è½¬æ¢,ç¡®ä¿ç”¨æˆ·åœ¨å„ç§è´Ÿè½½æ¡ä»¶ä¸‹éƒ½èƒ½è·å¾—æœ€ä½³ä½“éªŒã€‚

è¯¥å®ç°ä¸ºæœªæ¥çš„é«˜çº§ä¼˜åŒ–(GPUè´Ÿè½½ã€é¢„æµ‹æ€§è·³å¸§ç­‰)å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
